name: Create Daily CSV from Spreadsheet

# GASã‹ã‚‰ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ(repository_dispatch)ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹
on:
  repository_dispatch:
    types: [spreadsheet-data]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ä¿å­˜ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹
          token: ${{ secrets.GH_TOKEN }}

      # 2. dailyãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      # â˜… ä¿®æ­£ï¼š Google Driveã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‹ã‚‰curlã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      - name: Create Daily CSV
        run: |
          mkdir -p daily
          # GASã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸGoogle Driveã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’ä½¿ç”¨
          # -L ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¾“ã†ãŸã‚ã«å¿…è¦
          curl -L "${{ github.event.client_payload.download_url }}" -o daily/${{ github.event.client_payload.filename }}
      
      # 3. å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit & Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add daily/${{ github.event.client_payload.filename }}
          
          # â˜… ä¿®æ­£ï¼š å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆã€Œå¤‰æ›´ãªã—ã€ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼‰
          git diff --staged --quiet || git commit -m "ğŸ“ˆ Automated daily data update: ${{ github.event.client_payload.filename }}"
          
          git push

